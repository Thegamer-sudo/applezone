---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Clean3DViewer from '../../components/Clean3DViewer.jsx';
import { getAllIphones, formatPrice } from '../../data/iphones.js';

// Export getStaticPaths to tell Astro which pages to generate
export async function getStaticPaths() {
  const allIphones = getAllIphones();
  
  return allIphones.map(iphone => ({
    params: { id: iphone.id },
    props: { iphone }
  }));
}

const { iphone } = Astro.props;

// Function to map color names to hex codes
function getColorHex(colorName) {
  const colorMap = {
    'Black': '#1D1D1F',
    'Space Black': '#1D1D1F',
    'White': '#F5F5F7',
    'Silver': '#E4E4E6',
    'Space Gray': '#535150',
    'Graphite': '#535150',
    'Blue': '#007AFF',
    'Pacific Blue': '#007AFF',
    'Sierra Blue': '#64D2FF',
    'Deep Purple': '#800080',
    'Purple': '#800080',
    'Green': '#34C759',
    'Midnight Green': '#004953',
    'Yellow': '#FFD60A',
    'Gold': '#FFD700',
    'Coral': '#FF7F50',
    'Red': '#FF3B30',
    'Pink': '#FF2D55',
    'Natural Titanium': '#8E8E93',
    'Blue Titanium': '#5AC8FA',
    'White Titanium': '#F2F2F7'
  };
  
  return colorMap[colorName] || '#1D1D1F';
}

const hexColors = iphone.colors.map(color => getColorHex(color));

// Get unique storage and condition options
const storageOptions = Array.from(new Set(iphone.variants.map(v => v.storage)));
const conditionOptions = Array.from(new Set(iphone.variants.map(v => v.condition)));
---

<BaseLayout>
    <!-- Breadcrumb -->
    <div class="container mx-auto px-4 pt-24 pb-8">
        <a href="/products" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
            Back to All iPhones
        </a>
    </div>

    <!-- Product Detail -->
    <div class="container mx-auto px-4 pb-20">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
            <!-- Left Column - 3D iPhone Viewer -->
            <div class="flex justify-center">
                <div class="w-full max-w-2xl">
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-200">
                        <Clean3DViewer 
                            client:load 
                            color={hexColors[0] || '#1D1D1F'} 
                        />
                    </div>
                </div>
            </div>

            <!-- Right Column - Details & Pricing -->
            <div class="space-y-12">
                <!-- Title ONLY - NO DESCRIPTION -->
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">{iphone.name}</h1>
                </div>

                <!-- Price Display (Hidden until selection) -->
                <div id="price-section" class="hidden bg-gradient-to-r from-blue-50 to-white rounded-2xl p-10 border-2 border-blue-200 shadow-lg">
                    <div class="text-center">
                        <div class="text-sm text-gray-500 mb-3 uppercase tracking-wider">Selected Price</div>
                        <div class="text-6xl font-bold text-gray-900 mb-4" id="price-display"></div>
                        <div class="text-lg text-gray-700 font-medium" id="selection-details"></div>
                    </div>
                </div>

                <!-- Storage & Condition Selection -->
                <div class="space-y-10">
                    <!-- Storage Options -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Storage Capacity</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {storageOptions.map(storage => (
                                <button 
                                    class="storage-button bg-white border-2 border-gray-300 text-gray-800 py-4 rounded-xl font-medium transition-all duration-200 text-center hover:border-blue-500"
                                    data-storage={storage}
                                >
                                    {storage}
                                </button>
                            ))}
                        </div>
                    </div>

                    <!-- Condition Options -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Device Condition</h3>
                        <div class="grid grid-cols-2 gap-4">
                            {conditionOptions.map(condition => (
                                <button 
                                    class="condition-button bg-white border-2 border-gray-300 text-gray-800 py-4 rounded-xl font-medium transition-all duration-200 text-center hover:border-blue-500"
                                    data-condition={condition}
                                >
                                    {condition}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                <!-- CTA Buttons (Hidden until price shows) -->
                <div id="cta-section" class="hidden">
                    <div class="flex flex-col sm:flex-row gap-6 pt-8">
                        <a 
                            id="whatsapp-link"
                            href="#"
                            target="_blank"
                            class="inline-flex items-center justify-center bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold px-10 py-5 rounded-2xl hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl flex-1 text-center text-lg"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            Contact to Purchase
                        </a>
                        <a 
                            href="/products"
                            class="inline-flex items-center justify-center bg-white border-2 border-gray-300 text-gray-700 font-medium px-10 py-5 rounded-2xl hover:bg-gray-50 hover:border-gray-400 transition-all flex-1 text-center"
                        >
                            View Other Models
                        </a>
                    </div>
                </div>

                <!-- Included Benefits -->
                <div class="pt-12 border-t border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900 mb-8">Included with Every Purchase</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="flex items-center space-x-4 bg-green-50 p-6 rounded-xl">
                            <div class="h-12 w-12 rounded-full bg-green-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">4 Months Warranty</div>
                                <div class="text-sm text-gray-600">Complete peace of mind</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 bg-blue-50 p-6 rounded-xl">
                            <div class="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">4 Months Lay-by</div>
                                <div class="text-sm text-gray-600">Flexible payment plan</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4 bg-purple-50 p-6 rounded-xl">
                            <div class="h-12 w-12 rounded-full bg-purple-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600">
                                    <rect x="1" y="3" width="15" height="13"></rect>
                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Free Accessories</div>
                                <div class="text-sm text-gray-600">Premium accessories included</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script is:inline>
    // SIMPLE, WORKING JAVASCRIPT - NO COMPLEX LOGIC
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== PRODUCT PAGE LOADED ===');
        console.log('iPhone: {iphone.name}');
        console.log('Variants:', {JSON.stringify(iphone.variants)});
        
        // State
        let selectedStorage = null;
        let selectedCondition = null;
        
        // Get DOM elements
        const priceSection = document.getElementById('price-section');
        const priceDisplay = document.getElementById('price-display');
        const selectionDetails = document.getElementById('selection-details');
        const ctaSection = document.getElementById('cta-section');
        const whatsappLink = document.getElementById('whatsapp-link');
        
        // Get all variants from the page
        const variants = {JSON.stringify(iphone.variants)};
        
        // Function to update button styles
        function updateButtonStyles() {
            // Update storage buttons
            document.querySelectorAll('.storage-button').forEach(btn => {
                const storage = btn.getAttribute('data-storage');
                if (storage === selectedStorage) {
                    btn.classList.add('border-blue-600', 'bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.classList.remove('border-gray-300', 'bg-white', 'text-gray-800');
                } else {
                    btn.classList.remove('border-blue-600', 'bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.classList.add('border-gray-300', 'bg-white', 'text-gray-800');
                }
            });
            
            // Update condition buttons
            document.querySelectorAll('.condition-button').forEach(btn => {
                const condition = btn.getAttribute('data-condition');
                if (condition === selectedCondition) {
                    btn.classList.add('border-blue-600', 'bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.classList.remove('border-gray-300', 'bg-white', 'text-gray-800');
                } else {
                    btn.classList.remove('border-blue-600', 'bg-blue-100', 'text-blue-800', 'font-semibold');
                    btn.classList.add('border-gray-300', 'bg-white', 'text-gray-800');
                }
            });
        }
        
        // Function to find price for selected options
        function findPrice() {
            if (!selectedStorage || !selectedCondition) {
                return null;
            }
            
            // Find matching variant
            const variant = variants.find(v => 
                v.storage === selectedStorage && 
                v.condition === selectedCondition
            );
            
            return variant ? variant.price : null;
        }
        
        // Function to update price display
        function updatePriceDisplay() {
            const price = findPrice();
            
            if (price) {
                // Show price section
                priceSection.classList.remove('hidden');
                ctaSection.classList.remove('hidden');
                
                // Update price
                const formattedPrice = 'R' + price.toLocaleString('en-ZA');
                priceDisplay.textContent = formattedPrice;
                selectionDetails.textContent = `${selectedStorage} â€¢ ${selectedCondition}`;
                
                // Update WhatsApp link
                const message = `Hi, I'm interested in the {iphone.name} (${selectedStorage}, ${selectedCondition}) for ${formattedPrice} from AppleZone.`;
                whatsappLink.href = `https://wa.me/27796353542?text=${encodeURIComponent(message)}`;
                
                console.log('Price shown:', formattedPrice, 'for', selectedStorage, selectedCondition);
            } else {
                // Hide price section
                priceSection.classList.add('hidden');
                ctaSection.classList.add('hidden');
            }
        }
        
        // Function to handle storage button click
        function handleStorageClick(storage) {
            console.log('Storage selected:', storage);
            selectedStorage = storage;
            updateButtonStyles();
            updatePriceDisplay();
        }
        
        // Function to handle condition button click
        function handleConditionClick(condition) {
            console.log('Condition selected:', condition);
            selectedCondition = condition;
            updateButtonStyles();
            updatePriceDisplay();
        }
        
        // Add event listeners to storage buttons
        document.querySelectorAll('.storage-button').forEach(button => {
            button.addEventListener('click', function() {
                const storage = this.getAttribute('data-storage');
                handleStorageClick(storage);
            });
        });
        
        // Add event listeners to condition buttons
        document.querySelectorAll('.condition-button').forEach(button => {
            button.addEventListener('click', function() {
                const condition = this.getAttribute('data-condition');
                handleConditionClick(condition);
            });
        });
        
        // Auto-select first options
        const firstStorage = document.querySelector('.storage-button')?.getAttribute('data-storage');
        const firstCondition = document.querySelector('.condition-button')?.getAttribute('data-condition');
        
        if (firstStorage) {
            selectedStorage = firstStorage;
        }
        
        if (firstCondition) {
            selectedCondition = firstCondition;
        }
        
        // Update display with auto-selected options
        if (firstStorage || firstCondition) {
            setTimeout(() => {
                updateButtonStyles();
                updatePriceDisplay();
            }, 100);
        }
        
        console.log('Initial selection:', selectedStorage, selectedCondition);
        console.log('=== SETUP COMPLETE ===');
    });
</script>